<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JS Synth</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      color: #e0e0e0;
    }

    h1 {
      margin-bottom: 20px;
      font-weight: 300;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: #00d9ff;
      text-shadow: 0 0 20px rgba(0, 217, 255, 0.5);
    }

    .synth {
      background: linear-gradient(145deg, #2a2a4a, #1a1a2e);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 
        0 20px 60px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 900px;
      width: 100%;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .control-group label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
    }

    .knob-container {
      position: relative;
      width: 70px;
      height: 70px;
    }

    .knob {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: conic-gradient(from 225deg, #00d9ff, #ff006e, #00d9ff);
      cursor: pointer;
      position: relative;
      box-shadow: 
        0 5px 15px rgba(0, 0, 0, 0.4),
        inset 0 2px 4px rgba(255, 255, 255, 0.2);
      transition: transform 0.05s ease-out;
    }

    .knob::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      border-radius: 50%;
      background: linear-gradient(145deg, #2a2a4a, #1a1a2e);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .knob::after {
      content: '';
      position: absolute;
      top: 12px;
      left: 50%;
      width: 4px;
      height: 12px;
      background: #00d9ff;
      border-radius: 2px;
      transform-origin: center 23px;
      transform: translateX(-50%);
      box-shadow: 0 0 8px #00d9ff;
    }

    .knob-value {
      font-size: 14px;
      font-weight: bold;
      color: #00d9ff;
    }

    .slider-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .slider {
      -webkit-appearance: none;
      width: 120px;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(90deg, #1a1a2e, #2a2a4a);
      outline: none;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(145deg, #3a3a5a, #2a2a4a);
      cursor: pointer;
      box-shadow: 
        0 3px 10px rgba(0, 0, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border: 2px solid #00d9ff;
    }

    .slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(145deg, #3a3a5a, #2a2a4a);
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
      border: 2px solid #00d9ff;
    }

    .keyboard {
      display: block;
      position: relative;
      padding: 20px;
      background: linear-gradient(180deg, #1a1a2e, #0f0f1e);
      border-radius: 10px;
      box-shadow: inset 0 5px 15px rgba(0, 0, 0, 0.5);
      height: 240px;
      width: 820px;
    }

    .key.white {
      width: 50px;
      height: 180px;
      background: linear-gradient(180deg, #f5f5f5 0%, #e0e0e0 100%);
      border: 1px solid #ccc;
      border-radius: 0 0 5px 5px;
      cursor: pointer;
      position: absolute;
      top: 20px;
      transition: all 0.1s ease;
      box-shadow: 
        0 5px 15px rgba(0, 0, 0, 0.3),
        inset 0 -5px 10px rgba(0, 0, 0, 0.1);
    }

    .key.white:hover {
      background: linear-gradient(180deg, #ffffff 0%, #f0f0f0 100%);
    }

    .key.white:active, .key.white.active {
      background: linear-gradient(180deg, #00d9ff 0%, #0099cc 100%);
      transform: translateY(3px);
      box-shadow: 
        0 2px 10px rgba(0, 217, 255, 0.5),
        inset 0 -2px 5px rgba(0, 0, 0, 0.2);
    }

    .key.black {
      width: 35px;
      height: 110px;
      background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
      border: 1px solid #000;
      position: absolute;
      z-index: 2;
      top: 20px;
      box-shadow: 
        0 5px 15px rgba(0, 0, 0, 0.5),
        inset 0 -3px 5px rgba(0, 0, 0, 0.5);
    }

    .key.black:hover {
      background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 100%);
    }

    .key.black:active, .key.black.active {
      background: linear-gradient(180deg, #ff006e 0%, #cc0058 100%);
      transform: translateY(3px);
      box-shadow: 
        0 2px 10px rgba(255, 0, 110, 0.5),
        inset 0 -2px 5px rgba(0, 0, 0, 0.3);
    }

    .key-label {
      position: absolute;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
    }

    .key.black .key-label {
      color: #666;
      font-size: 9px;
    }

    .waveform-selector {
      display: flex;
      gap: 5px;
    }

    .wave-btn {
      padding: 8px 12px;
      border: 1px solid #444;
      background: #2a2a4a;
      color: #888;
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      transition: all 0.2s;
    }

    .wave-btn:first-child {
      border-radius: 5px 0 0 5px;
    }

    .wave-btn:last-child {
      border-radius: 0 5px 5px 0;
    }

    .wave-btn.active {
      background: #00d9ff;
      color: #1a1a2e;
      border-color: #00d9ff;
    }
  </style>
</head>
<body>
  <h1>JS Synth</h1>
  
  <div class="synth">
    <div class="controls">
      <div class="control-group">
        <label>Oscillator</label>
        <div class="waveform-selector">
          <button class="wave-btn active" data-wave="sine">Sine</button>
          <button class="wave-btn" data-wave="square">Square</button>
          <button class="wave-btn" data-wave="sawtooth">Saw</button>
          <button class="wave-btn" data-wave="triangle">Tri</button>
        </div>
      </div>

      <div class="control-group">
        <label>Attack</label>
        <div class="knob-container">
          <div class="knob" id="attackKnob" data-param="attack" data-value="0.1"></div>
        </div>
        <span class="knob-value" id="attackValue">0.1s</span>
      </div>

      <div class="control-group">
        <label>Release</label>
        <div class="knob-container">
          <div class="knob" id="releaseKnob" data-param="release" data-value="0.5"></div>
        </div>
        <span class="knob-value" id="releaseValue">0.5s</span>
      </div>

      <div class="control-group">
        <label>Detune</label>
        <div class="knob-container">
          <div class="knob" id="detuneKnob" data-param="detune" data-value="0"></div>
        </div>
        <span class="knob-value" id="detuneValue">0</span>
      </div>

      <div class="control-group">
        <label>Volume</label>
        <div class="slider-container">
          <input type="range" class="slider" id="volume" min="0" max="1" step="0.01" value="0.5">
          <span class="knob-value" id="volumeValue">50%</span>
        </div>
      </div>

      <div class="control-group">
        <label>Octave</label>
        <div class="slider-container">
          <input type="range" class="slider" id="octave" min="2" max="6" step="1" value="4">
          <span class="knob-value" id="octaveValue">4</span>
        </div>
      </div>
    </div>

    <div class="keyboard" id="keyboard"></div>
  </div>

  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.5;
    masterGain.connect(audioCtx.destination);

    const params = {
      waveform: 'sine',
      attack: 0.1,
      release: 0.5,
      detune: 0,
      volume: 0.5,
      octave: 4
    };

    const activeOscillators = new Map();

    const noteFrequencies = {
      'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13,
      'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00,
      'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
    };

    function getFrequency(noteWithOctave) {
      const note = noteWithOctave.slice(0, -1);
      const octaveChar = noteWithOctave.slice(-1);
      const octave = parseInt(octaveChar) + (params.octave - 4);
      
      if (isNaN(octave)) {
        return noteFrequencies[noteWithOctave] * Math.pow(2, params.octave - 4);
      }
      
      const baseFreq = noteFrequencies[note];
      return baseFreq * Math.pow(2, octave - 4);
    }

    const keyboardNotes = [
      { note: 'C3', type: 'white' }, { note: 'C#3', type: 'black' },
      { note: 'D3', type: 'white' }, { note: 'D#3', type: 'black' },
      { note: 'E3', type: 'white' },
      { note: 'F3', type: 'white' }, { note: 'F#3', type: 'black' },
      { note: 'G3', type: 'white' }, { note: 'G#3', type: 'black' },
      { note: 'A3', type: 'white' }, { note: 'A#3', type: 'black' },
      { note: 'B3', type: 'white' },
      { note: 'C4', type: 'white' }, { note: 'C#4', type: 'black' },
      { note: 'D4', type: 'white' }, { note: 'D#4', type: 'black' },
      { note: 'E4', type: 'white' },
      { note: 'F4', type: 'white' }, { note: 'F#4', type: 'black' },
      { note: 'G4', type: 'white' }, { note: 'G#4', type: 'black' },
      { note: 'A4', type: 'white' }, { note: 'A#4', type: 'black' },
      { note: 'B4', type: 'white' }
    ];

    const keyboard = document.getElementById('keyboard');

    keyboardNotes.forEach((key, index) => {
      const keyEl = document.createElement('div');
      keyEl.className = `key ${key.type}`;
      keyEl.dataset.note = key.note;

      const whiteKeysBefore = keyboardNotes.slice(0, index).filter(k => k.type === 'white').length;
      const whiteKeyWidth = 52;
      const offset = 50;
      
      if (key.type === 'white') {
        keyEl.style.left = `${whiteKeysBefore * whiteKeyWidth + offset}px`;
      } else {
        const blackKeyWidth = 35;
        keyEl.style.left = `${whiteKeysBefore * whiteKeyWidth - blackKeyWidth / 2 + offset}px`;
      }

      const label = document.createElement('span');
      label.className = 'key-label';
      label.textContent = key.note.slice(0, -1);
      keyEl.appendChild(label);

      keyEl.addEventListener('mousedown', () => playNote(key.note));
      keyEl.addEventListener('mouseup', () => stopNote(key.note));
      keyEl.addEventListener('mouseleave', () => stopNote(key.note));

      keyboard.appendChild(keyEl);
    });

    const keyMap = {
      'a': 'C3', 'w': 'C#3', 's': 'D3', 'e': 'D#3', 'd': 'E3',
      'f': 'F3', 't': 'F#3', 'g': 'G3', 'y': 'G#3', 'h': 'A3',
      'u': 'A#3', 'j': 'B3',
      'k': 'C4', 'o': 'C#4', 'l': 'D4', 'p': 'D#4', ';': 'E4'
    };

    document.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      const note = keyMap[e.key.toLowerCase()];
      if (note && !activeOscillators.has(note)) {
        const keyEl = document.querySelector(`.key[data-note="${note}"]`);
        if (keyEl) keyEl.classList.add('active');
        playNote(note);
      }
    });

    document.addEventListener('keyup', (e) => {
      const note = keyMap[e.key.toLowerCase()];
      if (note) {
        const keyEl = document.querySelector(`.key[data-note="${note}"]`);
        if (keyEl) keyEl.classList.remove('active');
        stopNote(note);
      }
    });

    function playNote(note) {
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }

      if (activeOscillators.has(note)) {
        stopNote(note);
      }

      const osc = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      osc.type = params.waveform;
      osc.frequency.value = getFrequency(note);
      osc.detune.value = params.detune;
      
      gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
      gainNode.gain.linearRampToValueAtTime(params.volume, audioCtx.currentTime + params.attack);
      
      osc.connect(gainNode);
      gainNode.connect(masterGain);
      
      osc.start();
      
      activeOscillators.set(note, { osc, gainNode });
    }

    function stopNote(note) {
      const nodes = activeOscillators.get(note);
      if (nodes) {
        const { osc, gainNode } = nodes;
        gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
        gainNode.gain.setValueAtTime(gainNode.gain.value, audioCtx.currentTime);
        gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + params.release);
        
        setTimeout(() => {
          osc.stop();
          osc.disconnect();
          gainNode.disconnect();
        }, params.release * 1000 + 100);
        
        activeOscillators.delete(note);
      }
    }

    document.querySelectorAll('.wave-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.wave-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        params.waveform = btn.dataset.wave;
      });
    });

    const knobs = document.querySelectorAll('.knob');
    knobs.forEach(knob => {
      let isDragging = false;
      let startY, startValue;

      const updateKnob = (value) => {
        const param = knob.dataset.param;
        const normalizedValue = Math.max(0, Math.min(1, value));
        
        if (param === 'attack') {
          params.attack = 0.01 + normalizedValue * 0.99;
          document.getElementById('attackValue').textContent = params.attack.toFixed(2) + 's';
          knob.style.transform = `rotate(${normalizedValue * 270 - 135}deg)`;
        } else if (param === 'release') {
          params.release = 0.01 + normalizedValue * 1.99;
          document.getElementById('releaseValue').textContent = params.release.toFixed(2) + 's';
          knob.style.transform = `rotate(${normalizedValue * 270 - 135}deg)`;
        } else if (param === 'detune') {
          params.detune = (normalizedValue - 0.5) * 100;
          document.getElementById('detuneValue').textContent = Math.round(params.detune);
          knob.style.transform = `rotate(${normalizedValue * 270 - 135}deg)`;
        }
      };

      const setInitialRotation = () => {
        const param = knob.dataset.param;
        let normalizedValue;
        
        if (param === 'attack') {
          normalizedValue = (params.attack - 0.01) / 0.99;
        } else if (param === 'release') {
          normalizedValue = (params.release - 0.01) / 1.99;
        } else if (param === 'detune') {
          normalizedValue = (params.detune / 100) + 0.5;
        }
        
        knob.style.transform = `rotate(${normalizedValue * 270 - 135}deg)`;
      };
      
      setInitialRotation();

      knob.addEventListener('mousedown', (e) => {
        isDragging = true;
        startY = e.clientY;
        
        if (knob.dataset.param === 'attack') {
          startValue = (params.attack - 0.01) / 0.99;
        } else if (knob.dataset.param === 'release') {
          startValue = (params.release - 0.01) / 1.99;
        } else if (knob.dataset.param === 'detune') {
          startValue = (params.detune / 100) + 0.5;
        }
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const delta = (startY - e.clientY) / 100;
        const newValue = Math.max(0, Math.min(1, startValue + delta));
        
        const param = knob.dataset.param;
        if (param === 'attack') {
          params.attack = 0.01 + newValue * 0.99;
          document.getElementById('attackValue').textContent = params.attack.toFixed(2) + 's';
        } else if (param === 'release') {
          params.release = 0.01 + newValue * 1.99;
          document.getElementById('releaseValue').textContent = params.release.toFixed(2) + 's';
        } else if (param === 'detune') {
          params.detune = (newValue - 0.5) * 100;
          document.getElementById('detuneValue').textContent = Math.round(params.detune);
        }
        
        knob.style.transform = `rotate(${newValue * 270 - 135}deg)`;
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });
    });

    document.getElementById('volume').addEventListener('input', (e) => {
      params.volume = parseFloat(e.target.value);
      params.volume = params.volume;
      masterGain.gain.value = params.volume;
      document.getElementById('volumeValue').textContent = Math.round(params.volume * 100) + '%';
    });

    document.getElementById('octave').addEventListener('input', (e) => {
      params.octave = parseInt(e.target.value);
      document.getElementById('octaveValue').textContent = params.octave;
    });
  </script>
</body>
</html>
